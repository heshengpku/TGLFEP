!------------------------------------------------------------
! EPGYRO_tglf_map.f90
!
! PURPOSE:
!  Mapping from GYRO input variables to TGLF interface.
!------------------------------------------------------------

subroutine EPGYRO_tglf_map

  use tglf_interface
  use TGLFEP_interface

  implicit none

  integer,parameter :: nr = 17
  real,dimension(nr) :: as_2,as_3,taus_2,taus_3,betae,            &
                        rlns_1,rlns_2,rlns_3,rlts_1,rlts_2,rlts_3,&
                        rmin,rmaj,shift,zmaj,dzmaj,               &
                        kappa,s_kappa,delta,s_delta,zeta,s_zeta,  &
                        q,shear,rho_star,zeff,                    &
                        q_prime,p_prime,omega_TAE
  data rmin &
  /0.1,0.15,0.2,0.25,0.3,0.35, &
   0.4,0.45,0.5,0.55,0.6,0.65, &
   0.7,0.75,0.8,0.85,0.9/
  data rmaj &
  /2.786490,2.782493,2.777218,2.770936,2.763933,2.756475, &
   2.748783,2.741022,2.733304,2.725698,2.718240,2.710935, &
   2.703726,2.696495,2.689090,2.681331,2.673023/
  data shift &
  /-0.065581,-0.093513,-0.116487,-0.133764,-0.145413,-0.152136, &
   -0.154974,-0.155084,-0.153416,-0.150725,-0.147513,-0.144862, &
   -0.143954,-0.145823,-0.151030,-0.160081,-0.172838/
  data kappa &
  /1.714437,1.708131,1.699666,1.689486,1.678189,1.666455, &
   1.654981,1.644430,1.635405,1.628435,1.623931,1.622035, &
   1.622319,1.624300,1.627742,1.632713,1.639609/
  data s_kappa &
  /-0.005952,-0.013026,-0.022111,-0.032088,-0.041587,-0.049241, &
   -0.053765,-0.054099,-0.049370,-0.039069,-0.023441,-0.005795, &
    0.010302, 0.025170, 0.040996, 0.060810, 0.088657/
  data delta &
  /0.023079,0.032856,0.040888,0.047049,0.051445,0.054346, &
   0.056145,0.057229,0.057912,0.058431,0.058935,0.059489, &
   0.060167,0.061111,0.062559,0.064845,0.068460/
  data s_delta &
  /0.021059,0.026862,0.028386,0.026239,0.021552,0.015975, &
   0.011077,0.007518,0.005690,0.005386,0.006326,0.007868, &
   0.010913,0.017282,0.028827,0.048569,0.081535/
  data zeta &
  / 0.000245, 0.000293, 0.000284, 0.000210, 0.000093,-0.000066, &
   -0.000217,-0.000344,-0.000438,-0.000544,-0.000666,-0.000792, &
   -0.000699,-0.000194, 0.000831, 0.002413, 0.004547/
  data s_zeta &
  / 0.000135, 0.000144,-0.000207,-0.000439,-0.000838,-0.001067, &
   -0.001010,-0.000955,-0.000996,-0.001258,-0.001783,-0.000573, &
    0.003809, 0.011354, 0.020763, 0.031851, 0.043393/
  data q &
  /4.815780,4.793392,4.753109,4.693539,4.619299,4.541286, &
   4.474579,4.435943,4.441401,4.504278,4.632180,4.816568, &
   5.041974,5.311818,5.643148,6.065119,6.627190/
  data shear &
  /-0.009280,-0.018977,-0.042031,-0.072562,-0.101734,-0.115774, &
   -0.099367,-0.039015, 0.072459, 0.231877, 0.413393, 0.555543, &
    0.682423, 0.838489, 1.051303, 1.349959, 1.788808/
  data rho_star &
  /0.002711,0.002655,0.002533,0.002427,0.002308,0.002162, &
   0.002028,0.001891,0.001749,0.001604,0.001467,0.001326, &
   0.001188,0.001054,0.000919,0.000782,0.000637/
  data zeff &
  /1.397506,1.421588,1.451557,1.484075,1.517011,1.549875, &
   1.581787,1.611770,1.638860,1.661966,1.679764,1.690872, &
   1.693651,1.686360,1.667151,1.633922,1.585336/
  data as_2 &
  /0.890857,0.893073,0.895027,0.898587,0.902760,0.908708, &
   0.917053,0.926834,0.937002,0.947915,0.958543,0.967819, &
   0.975345,0.981611,0.986949,0.991486,0.994870/
  data taus_2 &
  /0.888835,0.893140,0.899346,0.907635,0.918237,0.931385, &
   0.947069,0.965834,0.988492,1.016212,1.050579,1.094063, &
   1.150267,1.225308,1.330382,1.488626,1.758556/
  data rlns_2 &
  /0.895849,1.198687,1.278705,1.235637,1.147446,1.048406, &
   0.953795,0.876475,0.803922,0.735402,0.689697,0.662532, &
   0.641968,0.612830,0.585383,0.573432,0.583222/
  data rlts_2 &
  /0.984968,1.372770,1.734803,2.005901,2.194745,2.276260, &
   2.299956,2.328558,2.367095,2.412219,2.452351,2.512274, &
   2.582966,2.673019,2.812959,3.030483,3.399810/
  data as_3 &
  /0.109143,0.106927,0.104973,0.101413,0.097240,0.091292, &
   0.082947,0.073166,0.062998,0.052085,0.041457,0.032181, &
   0.024655,0.018389,0.013051,0.008514,0.005130/
  data taus_3 &
  /13.286034,14.112598,15.214078,16.563543,18.142214,19.912565, &
   21.838457,23.947208,26.305764,29.020192,32.202286,36.024820, &
   40.680291,46.546949,54.401877,65.862619,84.944745/
  data rlns_3 &
  /1.524166,1.499710,1.974615,1.986477,2.261836,2.784994, &
   3.282442,3.744807,4.373427,5.211725,5.953254,6.402938, &
   6.669066,7.264052,8.349159,9.640538,10.839206/
  data rlts_3 &
  /0.030146,0.136508,0.304319,0.482379,0.632728,0.742214, &
   0.828746,0.898816,0.952999,0.996784,1.033857,1.082722, &
   1.155607,1.231081,1.300111,1.375913,1.536969/
  data rlns_1 &
  /0.964457,1.230875,1.351741,1.311762,1.255766,1.206825, &
   1.146929,1.086580,1.028998,0.969060,0.908653,0.848042, &
   0.791135,0.735640,0.687264,0.651321,0.636110/
  data rlts_1 &
  /1.063141,1.488758,1.890202,2.216040,2.452673,2.585840, &
   2.661259,2.754097,2.872693,3.019235,3.185475,3.410366, &
   3.704044,4.101557,4.709295,5.708176,7.602296/
  data betae &
  /0.001944,0.001764,0.001504,0.001292,0.001096,0.000904, &
   0.000750,0.000617,0.000500,0.000400,0.000320,0.000250, &
   0.000192,0.000146,0.000107,0.000075,0.000048/
  data q_prime &
  /-21.522079,-19.378651,-23.739033,-25.575889,-24.119799,-19.490997, &
   -12.434431, -3.791171,  5.717352, 15.551838, 24.639479, 30.504670, &
    35.404540, 42.059205, 52.310740, 68.732359, 96.992392/
  data p_prime &
  /0.014631,0.010265,0.008412,0.006230,0.005008,0.004059, &
   0.003101,0.002174,0.001783,0.001714,0.001599,0.001382, &
   0.001188,0.001082,0.001052,0.001101,0.001279/
  data omega_TAE &
  /1.195013,1.262217,1.381117,1.512698,1.673235,1.878897, &
   2.099470,2.341674,2.604628,2.878283,3.141529,3.427885, &
   3.740757,4.086973,4.503558,5.020825,5.752011/

  zmaj  = 0.0
  dzmaj = 0.0

  !if(mode_flag_in .lt. 1 .or. mode_flag_in .gt. 4) then
  !  write(*,*) 'mode_flag must be 1. EP+ITG/TEM drive'
  !  write(*,*) '                  2. EP drive only'
  !  write(*,*) '                  3. ITG/TEM drive only'
  !  write(*,*) '                  4. ITG/TEM in EP+ITG/TEM drive'
  !  write(*,*) 'mode_flag has been set as default 1.'
  !endif

  tglf_sign_bt_in = -1.0
  tglf_sign_it_in = -1.0

  tglf_zs_in(1) = -1.0
  tglf_zs_in(2) = 1.0
  tglf_zs_in(3) = 1.0
  
  tglf_mass_in(1) = 1.0/1600.
  tglf_mass_in(2) = 1.0
  tglf_mass_in(3) = 1.0

  tglf_use_bper_in = .true.

  tglf_geometry_flag_in = 1  ! Miller 

  if(ir .lt. 1) ir = 1
  if(ir .gt. nr) ir = 11
  !r1
  tglf_taus_in(1) = 1.0
  tglf_taus_in(2) = taus_2(ir)
  tglf_taus_in(3) = taus_3(ir)

  factor_max = 0.5*1.0/as_3(ir)
  if(factor_in .lt. 0.) factor_in = 0.0
  if(factor_in .gt. factor_max) factor_in = factor_max

  tglf_as_in(1) = 1.0
  tglf_as_in(2) = 1.0 - as_3(ir)*factor_in
  tglf_as_in(3) = as_3(ir)*factor_in

  if(mode_flag_in .eq. 2) then !EP drive only
    tglf_rlns_in(1) = 0.
    tglf_rlns_in(2) = 0.

    tglf_rlts_in(1) = 0.
    tglf_rlts_in(2) = 0.
  else
    tglf_rlns_in(1) = rlns_1(ir)
    tglf_rlns_in(2) = rlns_2(ir)

    tglf_rlts_in(1) = rlts_1(ir)
    tglf_rlts_in(2) = rlts_2(ir)
  endif

  !EP species
  if(mode_flag_in .eq. 3) then !ITG/TEM drive only
    tglf_rlns_in(3) = 0.
    tglf_rlts_in(3) = 0.

    !tglf_filter_in = 2.0
  else
    tglf_rlns_in(3) = rlns_3(ir)*scan_factor
    tglf_rlts_in(3) = rlts_3(ir)

    tglf_filter_in = 0.0   !The frequency threshold off
  endif

  !----------------------------------------------------------------
  ! Geometry parameters:
  ! s-alpha
  tglf_rmin_sa_in     = rmin(ir)
  tglf_rmaj_sa_in     = rmaj(ir)
  tglf_q_sa_in        = q(ir)*q_factor
  tglf_shat_sa_in     = shear(ir)*shat_factor
  tglf_alpha_sa_in    = 0.0
  tglf_xwell_sa_in    = 0.0
  tglf_theta0_sa_in   = 0.0
  tglf_b_model_sa_in  = 1
  tglf_ft_model_sa_in = 1
  ! Miller
  tglf_rmin_loc_in    = rmin(ir)
  tglf_rmaj_loc_in    = rmaj(ir)
  tglf_zmaj_loc_in    = zmaj(ir)
  tglf_drmajdx_loc_in = shift(ir)
  tglf_dzmajdx_loc_in = dzmaj(ir)
  tglf_kappa_loc_in   = kappa(ir)
  tglf_s_kappa_loc_in = s_kappa(ir)
  tglf_delta_loc_in   = delta(ir)
  tglf_s_delta_loc_in = s_delta(ir)
  tglf_zeta_loc_in    = zeta(ir)
  tglf_s_zeta_loc_in  = s_zeta(ir)
  tglf_q_loc_in       = q(ir)*q_factor
  tglf_q_prime_loc_in = q_prime(ir)*q_factor**2.0*shat_factor
  tglf_p_prime_loc_in = -p_prime(ir)*q_factor* &
                       (tglf_as_in(1)*tglf_taus_in(1)*(tglf_rlns_in(1)+tglf_rlts_in(1)) + &
                        tglf_as_in(2)*tglf_taus_in(2)*(tglf_rlns_in(2)+tglf_rlts_in(2)) + &
                        tglf_as_in(3)*tglf_taus_in(3)*(tglf_rlns_in(3)+tglf_rlts_in(3)))/ &
                       ((rlns_1(ir)+rlts_1(ir)) + &
                        as_2(ir)*taus_2(ir)*(rlns_2(ir)+rlts_2(ir)) + &
                        as_3(ir)*taus_3(ir)*(rlns_3(ir)+rlts_3(ir)))  
                        ! The negative sign comfirmed by Gary 7.13.2016
  !----------------------------------------------------------------
  tglf_betae_in = betae(ir)

  tglf_xnue_in = 0.
  tglf_zeff_in = zeff(ir)

  if(mode_flag_in .eq. 4) then !ITG/TEM in EP+ITG/TEM drive
    tglf_filter_in = 2.0
  endif

  ky_in = n_toroidal*tglf_q_loc_in/tglf_rmin_loc_in*rho_star(ir) !ky = n*q/(r/a)*rho_star
  !ky_in = n_toroidal*0.1*tglf_zs_in(3)/sqrt(tglf_mass_in(3)*tglf_taus_in(3))
  freq_AE_upper = freq_cutoff/q_factor*omega_TAE(ir) !freq_cutoff*omega_TAE

  tglf_dump_flag_in = .false.
  
end subroutine EPGYRO_tglf_map
